<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance System</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- Load the full version of jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Show the dropdown menu on hover */
        .navbar-nav .dropdown:hover .dropdown-menu {
            display: block;
            margin-top: 0;
        }

        /* Optional: Add a slight delay for a smoother experience */
        .navbar-nav .dropdown-menu {
            transition: all 0.3s ease-in-out;
        }

        /* Scrollable chart container */
        #chart_scroll_container {
            overflow-x: auto;
            padding-bottom: 20px;
        }

        /* Ensure the filter menu is scrollable */
        .google-visualization-controls-categoryfilter-dropdown {
            max-height: 150px; /* Adjust this value to control the visible dropdown height */
            overflow-y: auto;
        }
    </style>

    <!-- Load Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        // Load the Visualization API, the corechart package, and the controls package.
        google.charts.load('current', { 'packages': ['corechart', 'controls'] });

        // Set a callback to run when the Google Visualization API is loaded.
        google.charts.setOnLoadCallback(fetchDataAndDrawChart);

        function fetchDataAndDrawChart() {
            function fetchData() {
                $.ajax({
                    url: '/api/class-attendance',
                    method: 'GET',
                    dataType: 'json',
                    success: function (response) {
                        drawDashboard(response);
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching data:', error);
                    }
                });
            }

            function drawDashboard(data) {
                var dataTable = new google.visualization.DataTable();
                dataTable.addColumn('string', 'Date');
                dataTable.addColumn('number', 'English');
                dataTable.addColumn('number', 'Science');
                dataTable.addColumn('number', 'Math');

                data.forEach(function (row) {
                    var date = new Date(row.dateString);
                    var dateString = date.toLocaleDateString();
                    var englishCount = parseInt(row.EnglishAttendance);
                    var mathCount = parseInt(row.MathAttendance);
                    var sciCount = parseInt(row.ScienceAttendance);

                    dataTable.addRow([dateString, englishCount, sciCount, mathCount]);
                });

                var dashboard = new google.visualization.Dashboard(
                    document.getElementById('dashboard_div')
                );

                var dateSlider = new google.visualization.ControlWrapper({
                    'controlType': 'CategoryFilter',
                    'containerId': 'filter_div',
                    'options': {
                        'filterColumnIndex': 0,
                        'ui': {
                            'label': 'Select Date Range',
                            'allowMultiple': false,
                            'allowTyping': false,
                            'cssClass': 'scrollable-dropdown',
                            'selectedValuesLayout': 'belowStacked'
                        }
                    }
                });

                var barChart = new google.visualization.ChartWrapper({
                    'chartType': 'ColumnChart',
                    'containerId': 'attendance_chart_div',
                    'options': {
                        'title': 'Attendance by Date',
                        'hAxis': { title: 'Date' },
                        'vAxis': { title: 'Attendance Count' },
                        'colors': ['#1b9e77', '#d95f02', '#7570b3'],
                        'height': 400,
                        'width': 1600, // Set width to ensure scrolling
                        'isStacked': false
                    }
                });

                dashboard.bind(dateSlider, barChart);
                dashboard.draw(dataTable);
            }

            $(document).ready(function () {
                fetchData();
            });
        }
    </script>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="/">Attendance System</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown"
            aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav ml-auto">
                <!-- Dropdown for Adding Classes -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="addClassesDropdown" role="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Add Classes
                    </a>
                    <div class="dropdown-menu" aria-labelledby="addClassesDropdown">
                        <a class="dropdown-item" href="/create_class">Manual Entry</a>
                        <a class="dropdown-item" href="/upload_classes">File Upload</a>
                    </div>
                </li>
                <!-- Dropdown for Enrolling Students -->
                <li class="nav-item">
                    <a class="nav-link" href="/enroll_student">Enroll Student</a>
                </li>
                <!-- Dropdown for Attendance -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="attendanceDropdown" role="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Attendance
                    </a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="attendanceDropdown">
                        <a class="dropdown-item" href="/overall_attendance">Overall Attendance</a>
                        <a class="dropdown-item" href="/attendance/search">Search For Classes</a>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-5">
        <h1 class="text-center">Welcome to the Attendance System</h1>
        <p class="text-center">Use the menu above to manage classes and enroll students.</p>
        <!-- Dashboard Section -->
        <div id="dashboard_div">
            <!-- Filter Section -->
            <div id="filter_div"></div>
            <!-- Scrollable Chart Section -->
            <div id="chart_scroll_container">
                <div id="attendance_chart_div" class="mt-5">
                    <!-- The chart will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Correct order of Bootstrap JavaScript dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>
